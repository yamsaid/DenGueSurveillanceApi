<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Dengue</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    #dengueChart {
    width: 100% !important;
    height: 400px !important; /* adapte à ta convenance */
    }
</style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="mb-4">Suivi des cas de Dengue (Mensuel)</h2>

    <div class="row mb-3">
      <div class="col-md-6">
        <label for="annee" class="form-label">Choisir l’année :</label>
        <select id="annee" class="form-select" onchange="updateChart()">
          <!-- années ajoutées dynamiquement -->
        </select>
      </div>
      <div class="col-md-6">
        <label for="region" class="form-label">Choisir la région :</label>
        <select id="region" class="form-select" onchange="updateChart()">
          {% for r in regions %}
            <option value="{{ r }}" {% if r == region %}selected{% endif %}>{{ r }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <canvas id="dengueChart" height="100"></canvas>
    <div id="myChartLegend" class="mt-4"></div>
  </div>

  <script>
    let dengueChart = null;

    function populateYears() {
      const currentYear = new Date().getFullYear();
      const select = document.getElementById("annee");
      for (let y = currentYear; y >= 2020; y--) {
        const option = document.createElement("option");
        option.value = y;
        option.text = y;
        select.appendChild(option);
      }
      select.value = currentYear;
    }

    async function updateChart() {
      const annee = document.getElementById("annee").value;
      const region = document.getElementById("region").value;
      let url = `/indicateurs-mensuels?annee=${annee}`;
      if (region) url += `&region=${region}`;

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("Erreur API");
        const data = await res.json();

        const labels = data.map(d => d.mois);
        const cas = data.map(d => d.cas);
        const deces = data.map(d => d.deces);
        const hosp = data.map(d => d.hospitalises);

        const ctx = document.getElementById("dengueChart");
        if (dengueChart) dengueChart.destroy();

        dengueChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: "Cas",
                data: cas,
                borderColor: '#f3545d',
                backgroundColor: 'rgba(243, 84, 93, 0.4)',
                fill: true,
                tension: 0.3
              },
              {
                label: "Décès",
                data: deces,
                borderColor: '#fdaf4b',
                backgroundColor: 'rgba(253, 175, 75, 0.4)',
                fill: true,
                tension: 0.3
              },
              {
                label: "Hospitalisations",
                data: hosp,
                borderColor: '#177dff',
                backgroundColor: 'rgba(23, 125, 255, 0.4)',
                fill: true,
                tension: 0.3
              }
            ]
          },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                display: true,
                text: `Évolution mensuelle - ${annee}`
                },
                legend: {
                display: true,
                position: 'top'
                },
                tooltip: {
                mode: 'index',
                intersect: false
                }
            },
            layout: {
                padding: {
                left: 10,
                right: 10,
                top: 10,
                bottom: 10
                }
            },
            scales: {
                y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    padding: 10
                },
                title: {
                    display: true,
                    text: 'Nombre de cas'
                }
                },
                x: {
                ticks: {
                    maxRotation: 0,
                    autoSkip: true
                },
                title: {
                    display: true,
                    text: 'Mois'
                }
                }
            }
            }

        });

        // Affiche la légende
        const legendContainer = document.getElementById("myChartLegend");
        legendContainer.innerHTML = dengueChart.generateLegend();
      } catch (error) {
        console.error("Erreur : ", error);
        alert("Impossible de charger les données.");
      }
    }

    populateYears();
    updateChart();
  </script>
</body>
</html>
