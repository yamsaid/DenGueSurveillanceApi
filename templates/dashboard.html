{% extends "base.html" %}

{% block title %}Dashboard - Système de Surveillance Dengue{% endblock %}

{% block extra_css %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- html2canvas et jsPDF pour l'export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- FileSaver pour l'export PNG -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        /* Dashboard specific styles */
        :root {
            --primary-color: #3B82F6;
            --secondary-color: #10B981;
            --accent-color: #F59E0B;
            --danger-color: #EF4444;
            --neutral-color: #6B7280;
            --card-bg: #FFFFFF;
            --border-color: #E5E7EB;
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
        }


        /* Page Content */
        .page-content {
            padding: 2rem 0;
            min-height: calc(100vh - 80px);
        }

        .page-header {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .page-subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Métriques Cards */
        .metrics-section {
            margin-bottom: 3rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.1);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-color);
        }

        .metric-card.cases::before { background: var(--primary-color); }
        .metric-card.positive::before { background: var(--secondary-color); }
        .metric-card.hospitalized::before { background: var(--accent-color); }
        .metric-card.deaths::before { background: var(--danger-color); }
        .metric-card.variants::before { background: #8B5CF6; }

        .metric-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .metric-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .metric-icon.cases { background: var(--primary-color); }
        .metric-icon.positive { background: var(--secondary-color); }
        .metric-icon.hospitalized { background: var(--accent-color); }
        .metric-icon.deaths { background: var(--danger-color); }
        .metric-icon.variants { background: #8B5CF6; }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .metric-change {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .metric-change.positive {
            color: var(--secondary-color);
        }

        .metric-change.negative {
            color: var(--danger-color);
        }

        .metric-change.neutral {
            color: var(--neutral-color);
        }

        /* Filtres */
        .filters-section {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .filters-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .form-label {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .form-control {
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn-primary {
            background: var(--primary-color);
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #2563EB;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: var(--neutral-color);
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #4B5563;
            transform: translateY(-1px);
        }

        /* Graphiques */
        .charts-section {
            margin-bottom: 3rem;
        }

        .chart-container {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-export {
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .btn-export:hover {
            background: #059669;
            color: white;
            transform: translateY(-1px);
            text-decoration: none;
        }

        .btn-export.danger {
            background: var(--danger-color);
        }

        .btn-export.danger:hover {
            background: #DC2626;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        /* Actions Section */
        .actions-section {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .actions-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .action-btn {
            background: linear-gradient(135deg, var(--primary-color) 0%, #2563EB 100%);
            color: white;
            border: none;
            border-radius: 0.75rem;
            padding: 1.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            min-height: 80px;
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
            color: white;
            text-decoration: none;
        }

        .action-btn.secondary {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #059669 100%);
        }

        .action-btn.secondary:hover {
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }

        .action-btn.accent {
            background: linear-gradient(135deg, var(--accent-color) 0%, #D97706 100%);
        }

        .action-btn.accent:hover {
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
        }

        /* Loading States */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .page-title {
                font-size: 2rem;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .chart-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .chart-actions {
                width: 100%;
                justify-content: space-between;
            }

            .actions-grid {
                grid-template-columns: 1fr;
            }

            .header-logo {
                font-size: 1.25rem;
            }

            .nav-link-modern {
                padding: 0.75rem 1rem !important;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
    </style>
{% endblock %}

{% block content %}
            <!-- Page Header -->
            <div class="page-header fade-in">
                <h1 class="page-title">
                    <i class="fas fa-chart-line text-primary me-3"></i>
                    Dashboard de Surveillance
                </h1>
                <p class="page-subtitle">
                    Visualisez les indicateurs clés de la dengue en temps réel avec des graphiques interactifs et des métriques détaillées.
                </p>
            </div>

            <!-- Section 1: Métriques de la Semaine en Cours -->
            <div class="metrics-section fade-in">
                <h2 class="section-title mb-4">
                    <i class="fas fa-calendar-week text-primary me-2"></i>
                    Métriques de la Semaine en Cours
                </h2>
                
                <div class="metrics-grid">
                    <!-- Total des cas enregistrés -->
                    <div class="metric-card cases">
                        <div class="metric-header">
                            <div class="metric-icon cases">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="metric-value" id="total-cases">
                            <span class="loading-spinner"></span>
                        </div>
                        <div class="metric-label">Total des cas enregistrés</div>
                        <div class="metric-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="cases-change">+12% cette semaine</span>
                        </div>
                    </div>

                    <!-- Tests positifs -->
                    <div class="metric-card positive">
                        <div class="metric-header">
                            <div class="metric-icon positive">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </div>
                        <div class="metric-value" id="positive-tests">
                            <span class="loading-spinner"></span>
                        </div>
                        <div class="metric-label">Tests positifs</div>
                        <div class="metric-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="positive-change">+8% cette semaine</span>
                        </div>
                    </div>

                    <!-- Hospitalisations -->
                    <div class="metric-card hospitalized">
                        <div class="metric-header">
                            <div class="metric-icon hospitalized">
                                <i class="fas fa-hospital"></i>
                            </div>
                        </div>
                        <div class="metric-value" id="hospitalizations">
                            <span class="loading-spinner"></span>
                        </div>
                        <div class="metric-label">Hospitalisations</div>
                        <div class="metric-change negative">
                            <i class="fas fa-arrow-down"></i>
                            <span id="hospitalization-change">-3% cette semaine</span>
                        </div>
                    </div>

                    <!-- Décès -->
                    <div class="metric-card deaths">
                        <div class="metric-header">
                            <div class="metric-icon deaths">
                                <i class="fas fa-heart-broken"></i>
                            </div>
                        </div>
                        <div class="metric-value" id="deaths">
                            <span class="loading-spinner"></span>
                        </div>
                        <div class="metric-label">Décès</div>
                        <div class="metric-change neutral">
                            <i class="fas fa-minus"></i>
                            <span id="deaths-change">Stable cette semaine</span>
                        </div>
                    </div>

                    <!-- Variants/Sérotypes -->
                    <div class="metric-card variants">
                        <div class="metric-header">
                            <div class="metric-icon variants">
                                <i class="fas fa-dna"></i>
                            </div>
                        </div>
                        <div class="metric-value" id="variants">
                            <span class="loading-spinner"></span>
                        </div>
                        <div class="metric-label">Variants/Sérotypes</div>
                        <div class="metric-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="variants-change">+1 nouveau variant</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section Filtres -->
            <div class="filters-section fade-in">
                <h3 class="filters-title">
                    <i class="fas fa-filter text-primary me-2"></i>
                    Filtres de Navigation
                </h3>
                
                <form id="filters-form">
                    <div class="filters-grid">
                        <div>
                            <label for="region-filter" class="form-label">Région</label>
                            <select class="form-control" id="region-filter" name="region">
                                <option value="Toutes">Toutes les régions</option>
                                {% for region in regions %}
                                <option value="{{ region }}">{{ region }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div>
                            <label for="district-filter" class="form-label">District</label>
                            <select class="form-control" id="district-filter" name="district">
                                <option value="Toutes">Tous les districts</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="year-filter" class="form-label">Année</label>
                            <select class="form-control" id="year-filter" name="year">
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                            </select>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary flex-fill">
                                <i class="fas fa-search me-2"></i>Appliquer les filtres
                            </button>
                            <button type="button" class="btn btn-secondary" id="reset-filters">
                                <i class="fas fa-undo me-2"></i>Réinitialiser
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Section 2: Évolution Hebdomadaire -->
            <div class="charts-section fade-in">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fas fa-chart-line text-primary me-2"></i>
                            Évolution Hebdomadaire
                        </h3>
                        <div class="chart-actions">
                            <button class="btn-export" onclick="exportChart('weekly-chart', 'png')">
                                <i class="fas fa-download"></i>PNG
                            </button>
                            <button class="btn-export danger" onclick="exportChart('weekly-chart', 'pdf')">
                                <i class="fas fa-file-pdf"></i>PDF
                            </button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="weekly-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Section 3: Évolution Mensuelle -->
            <div class="charts-section fade-in">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fas fa-chart-bar text-primary me-2"></i>
                            Évolution Mensuelle
                        </h3>
                        <div class="chart-actions">
                            <button class="btn-export" onclick="exportChart('monthly-chart', 'png')">
                                <i class="fas fa-download"></i>PNG
                            </button>
                            <button class="btn-export danger" onclick="exportChart('monthly-chart', 'pdf')">
                                <i class="fas fa-file-pdf"></i>PDF
                            </button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="monthly-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Section Actions -->
            <div class="actions-section fade-in">
                <h3 class="actions-title">
                    <i class="fas fa-cogs text-primary me-2"></i>
                    Actions Rapides
                </h3>
                
                <div class="actions-grid">
                    <a href="/dashboard/indicateurs-powerbi" class="action-btn">
                        <i class="fas fa-chart-bar fa-2x"></i>
                        <div>
                            <div class="fw-bold">Statistiques Avancées</div>
                            <small>Indicateurs détaillés</small>
                        </div>
                    </a>
                    
                    <button class="action-btn secondary" onclick="exportFullReport()">
                        <i class="fas fa-file-pdf fa-2x"></i>
                        <div>
                            <div class="fw-bold">Rapport Complet</div>
                            <small>Export PDF</small>
                        </div>
                    </button>
                    
                    <button class="action-btn accent" onclick="refreshData()">
                        <i class="fas fa-sync-alt fa-2x"></i>
                        <div>
                            <div class="fw-bold">Actualiser</div>
                            <small>Nouvelles données</small>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/static/assets/js/core/jquery-3.7.1.min.js"></script>
    <script src="/static/assets/js/core/popper.min.js"></script>
    <script src="/static/assets/js/core/bootstrap.min.js"></script>
    <script src="/static/assets/js/kaiadmin.min.js"></script>

    <script>
        // Variables globales
        let weeklyChart, monthlyChart;
        let currentFilters = {
            region: 'Toutes',
            district: 'Toutes',
            year: '2025'
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadMetrics();
            loadChartData();
            setupEventListeners();
        });

        // Configuration des événements
        function setupEventListeners() {
            // Filtres
            document.getElementById('filters-form').addEventListener('submit', function(e) {
                e.preventDefault();
                applyFilters();
            });

            document.getElementById('reset-filters').addEventListener('click', function() {
                resetFilters();
            });

            // Changement de région
            document.getElementById('region-filter').addEventListener('change', function() {
                updateDistricts();
            });
        }

        // Initialisation des graphiques
        function initializeCharts() {
            // Graphique hebdomadaire
            const weeklyCtx = document.getElementById('weekly-chart').getContext('2d');
            weeklyChart = new Chart(weeklyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Cas',
                            data: [],
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Hospitalisés',
                            data: [],
                            borderColor: '#F59E0B',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Positifs',
                            data: [],
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Décès',
                            data: [],
                            borderColor: '#EF4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#fff',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });

            // Graphique mensuel
            const monthlyCtx = document.getElementById('monthly-chart').getContext('2d');
            monthlyChart = new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Cas',
                            data: [],
                            backgroundColor: '#3B82F6',
                            borderRadius: 8
                        },
                        {
                            label: 'Hospitalisés',
                            data: [],
                            backgroundColor: '#F59E0B',
                            borderRadius: 8
                        },
                        {
                            label: 'Positifs',
                            data: [],
                            backgroundColor: '#10B981',
                            borderRadius: 8
                        },
                        {
                            label: 'Décès',
                            data: [],
                            backgroundColor: '#EF4444',
                            borderRadius: 8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#fff',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Chargement des métriques
        async function loadMetrics() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                // Mise à jour des métriques
                updateMetric('total-cases', data.semaine_en_cours.total_cases || 0);
                updateMetric('positive-tests', data.semaine_en_cours.total_positives || 0);
                updateMetric('hospitalizations', data.semaine_en_cours.total_hospitalized || 0);
                updateMetric('deaths', data.semaine_en_cours.total_deaths || 0);
                updateMetric('variants', data.semaine_en_cours.variants || 0);
                
            } catch (error) {
                console.error('Erreur lors du chargement des métriques:', error);
                showError('Erreur lors du chargement des métriques');
            }
        }

        // Mise à jour d'une métrique
        function updateMetric(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = value.toLocaleString();
            }
        }

        // Chargement des données des graphiques
        async function loadChartData() {
            try {
                // Données hebdomadaires
                const weeklyResponse = await fetch(`/api/data/hebdomadaires?annee=${currentFilters.year}&mois=${currentFilters.month}&region=${currentFilters.region}&district=${currentFilters.district}`);
                const weeklyData = await weeklyResponse.json();
                updateWeeklyChart(weeklyData);

                // Données mensuelles
                const monthlyResponse = await fetch(`/api/data/mensuels?annee=${currentFilters.year}&region=${currentFilters.region}&district=${currentFilters.district}`);
                const monthlyData = await monthlyResponse.json();
                updateMonthlyChart(monthlyData);
                
            } catch (error) {
                console.error('Erreur lors du chargement des données:', error);
                showError('Erreur lors du chargement des graphiques');
            }
        }

        // Mise à jour du graphique hebdomadaire
        function updateWeeklyChart(data) {
            if (!weeklyChart) return;

            const labels = data.map(item => item.semaine || item.period);
            const cases = data.map(item => item.cas || 0);
            const hospitalized = data.map(item => item.hospitalises || 0);
            const positive = data.map(item => item.positifs || 0);
            const deaths = data.map(item => item.deces || 0);

            weeklyChart.data.labels = labels;
            weeklyChart.data.datasets[0].data = cases;
            weeklyChart.data.datasets[1].data = hospitalized;
            weeklyChart.data.datasets[2].data = positive;
            weeklyChart.data.datasets[3].data = deaths;
            weeklyChart.update();
        }

        // Mise à jour du graphique mensuel
        function updateMonthlyChart(data) {
            if (!monthlyChart) return;

            const labels = data.map(item => item.mois);
            const cases = data.map(item => item.cas || 0);
            const hospitalized = data.map(item => item.hospitalises || 0);
            const positive = data.map(item => item.positifs || 0);
            const deaths = data.map(item => item.deces || 0);

            monthlyChart.data.labels = labels;
            monthlyChart.data.datasets[0].data = cases;
            monthlyChart.data.datasets[1].data = hospitalized;
            monthlyChart.data.datasets[2].data = positive;
            monthlyChart.data.datasets[3].data = deaths;
            monthlyChart.update();
        }

        // Application des filtres
        function applyFilters() {
            currentFilters.region = document.getElementById('region-filter').value;
            currentFilters.district = document.getElementById('district-filter').value;
            currentFilters.year = document.getElementById('year-filter').value;

            loadChartData();
            showSuccess('Filtres appliqués avec succès');
        }

        // Réinitialisation des filtres
        function resetFilters() {
            document.getElementById('region-filter').value = 'Toutes';
            document.getElementById('district-filter').value = 'Toutes';
            document.getElementById('year-filter').value = '2025';
            
            currentFilters = {
                region: 'Toutes',
                district: 'Toutes',
                year: '2025'
            };

            updateDistricts();
            loadChartData();
            showSuccess('Filtres réinitialisés');
        }

        // Mise à jour des districts selon la région
        async function updateDistricts() {
            const region = document.getElementById('region-filter').value;
            const districtSelect = document.getElementById('district-filter');
            
            if (region === 'Toutes') {
                districtSelect.innerHTML = '<option value="Toutes">Tous les districts</option>';
                return;
            }

            try {
                const response = await fetch(`/api/districts?region=${encodeURIComponent(region)}`);
                const districts = await response.json();
                
                districtSelect.innerHTML = '<option value="Toutes">Tous les districts</option>';
                districts.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    districtSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erreur lors du chargement des districts:', error);
            }
        }

        // Export de graphique
        function exportChart(chartId, format) {
            const canvas = document.getElementById(chartId);
            const chart = chartId === 'weekly-chart' ? weeklyChart : monthlyChart;
            
            if (format === 'png') {
                const link = document.createElement('a');
                link.download = `dashboard_${chartId}_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL();
                link.click();
            } else if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;

                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save(`dashboard_${chartId}_${new Date().toISOString().split('T')[0]}.pdf`);
            }
        }

        // Export du rapport complet
        async function exportFullReport() {
            try {
                showLoading('Génération du rapport en cours...');
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                
                // Titre
                pdf.setFontSize(20);
                pdf.text('Rapport de Surveillance Dengue', 20, 20);
                
                pdf.setFontSize(12);
                pdf.text(`Généré le: ${new Date().toLocaleDateString('fr-FR')}`, 20, 30);
                pdf.text(`Filtres: Région ${currentFilters.region}, District ${currentFilters.district}, Année ${currentFilters.year}`, 20, 40);
                
                // Métriques
                pdf.setFontSize(16);
                pdf.text('Métriques de la Semaine', 20, 60);
                
                const metrics = [
                    ['Total des cas', document.getElementById('total-cases').textContent],
                    ['Tests positifs', document.getElementById('positive-tests').textContent],
                    ['Hospitalisations', document.getElementById('hospitalizations').textContent],
                    ['Décès', document.getElementById('deaths').textContent],
                    ['Variants', document.getElementById('variants').textContent]
                ];
                
                let y = 80;
                metrics.forEach(([label, value]) => {
                    pdf.setFontSize(12);
                    pdf.text(`${label}: ${value}`, 20, y);
                    y += 10;
                });
                
                // Graphiques
                const charts = ['weekly-chart', 'monthly-chart'];
                y += 20;
                
                for (let i = 0; i < charts.length; i++) {
                    const canvas = document.getElementById(charts[i]);
                    const imgData = canvas.toDataURL('image/png');
                    
                    pdf.addPage();
                    pdf.setFontSize(16);
                    pdf.text(charts[i] === 'weekly-chart' ? 'Évolution Hebdomadaire' : 'Évolution Mensuelle', 20, 20);
                    
                    const imgWidth = 170;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    pdf.addImage(imgData, 'PNG', 20, 30, imgWidth, imgHeight);
                }
                
                pdf.save(`rapport_dengue_${new Date().toISOString().split('T')[0]}.pdf`);
                hideLoading();
                showSuccess('Rapport exporté avec succès');
                
            } catch (error) {
                console.error('Erreur lors de l\'export:', error);
                hideLoading();
                showError('Erreur lors de l\'export du rapport');
            }
        }

        // Actualisation des données
        async function refreshData() {
            try {
                showLoading('Actualisation des données...');
                await loadMetrics();
                await loadChartData();
                hideLoading();
                showSuccess('Données actualisées avec succès');
            } catch (error) {
                console.error('Erreur lors de l\'actualisation:', error);
                hideLoading();
                showError('Erreur lors de l\'actualisation');
            }
        }

        // Fonctions utilitaires
        function showLoading(message) {
            // Implémentation d'un indicateur de chargement
            console.log('Loading:', message);
        }

        function hideLoading() {
            // Masquer l'indicateur de chargement
            console.log('Loading finished');
        }

        function showSuccess(message) {
            // Afficher un message de succès
            console.log('Success:', message);
        }

        function showError(message) {
            // Afficher un message d'erreur
            console.error('Error:', message);
        }

        // Chargement initial des districts
        updateDistricts();
    </script>
{% endblock %} 